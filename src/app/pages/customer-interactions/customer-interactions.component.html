<div class="card flex" style="padding: 0;">
  <p-breadcrumb class="max-w-full" [style]="{'border-radius': '6px'}" [model]="_listMenuItems"
    [home]="_defaultHomeMenu" />
</div>

<div class="customer-interactions-container">
  <p-toast></p-toast>
  <p-card styleClass="p-card-shadow" [style]="{'border-radius': '6px'}">
    <div class="flex items-start gap-2 justify-between">
      <div class="text-2xl leading-8 text-color font-medium">Customer Interactions</div>
    </div>

    <div class="mt-6 mb-4 flex items-center justify-between">
      <p-iconfield iconPosition="left">
        <p-inputicon class="pi pi-search"> </p-inputicon>
        <input
        pInputText
        type="text"
        [(ngModel)]="_searchQuery"
        (ngModelChange)="_searchSubject.next($event)"
        placeholder="Search"
        />

      </p-iconfield>
      <div class="flex items-center gap-3">
        <p-button icon="pi pi-refresh" outlined severity="secondary" (onClick)="onRefreshData()" />
      </div>
    </div>

    <div class="flex-1 last:[&>td]:border-0 rounded-lg border border-surface w-full overflow-auto">
      <p-table [value]="tableData" stripedRows [paginator]="true" [rows]="_numberRows"
        [totalRecords]="_numberTotalRecords" [showCurrentPageReport]="true" [loading]="_booleanIsLoading"
        [rowsPerPageOptions]="[5, 10, 20, 30]" selectionMode="single"
        (onRowSelect)="onSelectRow($event)" dataKey="customer_id" [scrollable]="true" [style]="{'border-radius': '6px'}"
        [lazy]="true" (onLazyLoad)="onLazyLoad($event)">

        <ng-template pTemplate="header">
          <tr>
            <th>Customer ID</th>
            <th>Channel</th>
            <th>Start Time</th>
            <th>End Time</th>
            <th>Feedback Score</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-data>
          <tr [pSelectableRow]="data">
            <td>{{ data.customer_id || '-' }}</td>
            <td class="text-muted-color">{{ data.channel }}</td>
            <td class="text-muted-color">{{ data.start_time | date:'short' }}</td>
            <td class="text-muted-color">{{ data.end_time ? (data.end_time | date:'short') : '-' }}</td>
            <td>
              <p-tag [value]="data.customer_feedback_score ?? '-'" [severity]="data.customer_feedback_score >= 4 ? 'success' : 'warning'"></p-tag>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5">No user interaction data found.</td>
          </tr>
        </ng-template>

        <ng-template pTemplate="loadingbody">
          <tr>
            <td colspan="5" class="loading">Loading customers, please wait...</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </p-card>

  <p-dialog header="Customer Detail" [(visible)]="_booleanShowDataDialog" [modal]="true"
    [style]="{ width: '50vw' }" [closable]="true" [dismissableMask]="true">
    <ng-container *ngIf="selectedInteraction">
      <div class="p-fluid p-3">
        <div class="field mb-4">
          <label class="font-semibold block font-medium text-color mb-2">ID</label>
          <p>{{ selectedInteraction.id || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Conversation ID</label>
          <p>{{ selectedInteraction.conversation_id || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Customer ID</label>
          <p>{{ selectedInteraction.customer_id || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Start Time</label>
          <p>{{ selectedInteraction.start_time || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">End Time</label>
          <p>{{ selectedInteraction.end_time || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Duration (seconds)</label>
          <p>{{ selectedInteraction.duration_seconds || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Channel</label>
          <p>{{ selectedInteraction.channel || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Initial Query</label>
          <p>{{ selectedInteraction.initial_query || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Total Messages</label>
          <p>{{ selectedInteraction.total_messages || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Handoff to Agent</label>
          <p>{{ selectedInteraction.is_handoff_to_agent ? 'Yes' : 'No' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Agent ID</label>
          <p>{{ selectedInteraction.agent_id || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Agent Name</label>
          <p>{{ selectedInteraction.agent_name || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Conversation Status</label>
          <p>{{ selectedInteraction.conversation_status || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Detected Intent</label>
          <p>{{ selectedInteraction.detected_intent || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Main Topic</label>
          <p>{{ selectedInteraction.main_topic || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Keywords Extracted</label>
          <p>
            {{
              selectedInteraction.keywords_extracted && selectedInteraction.keywords_extracted.length > 0
                ? selectedInteraction.keywords_extracted.join(', ')
                : '-'
            }}
          </p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Sentiment Score</label>
          <p>{{ selectedInteraction.sentiment_score !== null && selectedInteraction.sentiment_score !== undefined ? selectedInteraction.sentiment_score : '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Product Involved</label>
          <p>{{ selectedInteraction.product_involved || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Customer Feedback ID</label>
          <p>{{ selectedInteraction.customer_feedback_id || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Customer Feedback Score</label>
          <p>{{ selectedInteraction.customer_feedback_score || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Customer Feedback Comment</label>
          <p>{{ selectedInteraction.customer_feedback_comment || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Feedback Submitted</label>
          <p>{{ selectedInteraction.feedback_submitted ? 'Yes' : 'No' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Others Information</label>
          <p>{{ selectedInteraction.others_information ? (selectedInteraction.others_information | json) : '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Created At</label>
          <p>{{ selectedInteraction.created_at || '-' }}</p>
          <p-divider></p-divider>
        </div>

        <div class="field">
          <label class="font-semibold block font-medium text-color mb-2">Updated At</label>
          <p>{{ selectedInteraction.updated_at || '-' }}</p>
          <p-divider></p-divider>
        </div>
      </div>
    </ng-container>
  </p-dialog>
</div>
